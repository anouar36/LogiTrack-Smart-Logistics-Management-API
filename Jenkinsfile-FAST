pipeline {
    agent any

    tools {
        maven 'M3'
    }

    stages {
        stage('1. Checkout Code (Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯)') {
            steps {
                checkout scm
            }
        }

        stage('2. Build & Test (Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø®ØªØ¨Ø§Ø±)') {
            steps {
                sh 'mvn clean verify'
            }
        }
        
        stage('3. SonarQube Analysis FAST (ØªØ­Ù„ÙŠÙ„ Ø³Ø±ÙŠØ¹)') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    withCredentials([string(credentialsId: 'sonar-global-token', variable: 'SONAR_LOGIN_TOKEN')]) {
                        sh """
                            mvn org.sonarsource.scanner.maven:sonar-maven-plugin:4.0.0.4121:sonar \
                            -Dsonar.projectKey=logitrack-api \
                            -Dsonar.projectName="LogiTrack API" \
                            -Dsonar.token=\${SONAR_LOGIN_TOKEN} \
                            -Dsonar.java.coveragePlugin=jacoco \
                            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
                            -Dsonar.scanner.skip=false
                        """
                    }
                }
                
                // Ù†ØªÙŠØ¬Ø© Ø³Ø±ÙŠØ¹Ø© Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Quality Gate
                echo "âœ… SonarQube analysis sent successfully!"
                echo "ğŸ” Check results at: http://localhost:9000/dashboard?id=logitrack-api"
            }
        }
    }

    post {
        always {
            // Ø£Ø±Ø´ÙØ© ØªÙ‚Ø§Ø±ÙŠØ± JUnit
            junit allowEmptyResults: true, testResultsPattern: 'target/surefire-reports/*.xml'
            
            // Ø£Ø±Ø´ÙØ© ØªÙ‚Ø§Ø±ÙŠØ± JaCoCo
            jacoco(execPattern: 'target/jacoco.exec')
            
            echo "ğŸš€ Pipeline completed! Check SonarQube dashboard for results."
        }
        
        success {
            echo "âœ… Build successful! All tests passed."
        }
        
        failure {
            echo "âŒ Build failed. Check the logs above."
        }
    }
}
